import{_ as n,c as a,b as o,o as e}from"./chunks/framework.B1z0IdBH.js";const y=JSON.parse('{"title":"Function Calling","description":"","frontmatter":{"myst":{"number_code_blocks":["python3"]}},"headers":[{"level":2,"title":"Preface","slug":"preface","link":"#preface","children":[]},{"level":2,"title":"What is function calling?","slug":"what-is-function-calling","link":"#what-is-function-calling","children":[]},{"level":2,"title":"Inference with Function Calling","slug":"inference-with-function-calling","link":"#inference-with-function-calling","children":[{"level":3,"title":"The Example Case","slug":"the-example-case","link":"#the-example-case","children":[]},{"level":3,"title":"Qwen-Agent","slug":"qwen-agent","link":"#qwen-agent","children":[]},{"level":3,"title":"Hugging Face transformers","slug":"hugging-face-transformers","link":"#hugging-face-transformers","children":[]},{"level":3,"title":"Ollama","slug":"ollama","link":"#ollama","children":[]},{"level":3,"title":"vLLM","slug":"vllm","link":"#vllm","children":[]},{"level":3,"title":"Discussions","slug":"discussions","link":"#discussions","children":[]}]},{"level":2,"title":"Function Calling Templates","slug":"function-calling-templates","link":"#function-calling-templates","children":[{"level":3,"title":"Starting from ReAct Prompting","slug":"starting-from-react-prompting","link":"#starting-from-react-prompting","children":[]},{"level":3,"title":"Qwen2 Function Calling Template","slug":"qwen2-function-calling-template","link":"#qwen2-function-calling-template","children":[]},{"level":3,"title":"Qwen2.5 Function Calling Templates","slug":"qwen2-5-function-calling-templates","link":"#qwen2-5-function-calling-templates","children":[]}]},{"level":2,"title":"Finally","slug":"finally","link":"#finally","children":[]}],"relativePath":"guide/framework/README.md","filePath":"guide/framework/README.md"}'),t={name:"guide/framework/README.md"};function l(p,s,c,r,i,E){return e(),a("div",null,s[0]||(s[0]=[o(`<h1 id="function-calling" tabindex="-1">Function Calling <a class="header-anchor" href="#function-calling" aria-label="Permalink to &quot;Function Calling&quot;">​</a></h1><h2 id="preface" tabindex="-1">Preface <a class="header-anchor" href="#preface" aria-label="Permalink to &quot;Preface&quot;">​</a></h2><p>Function calling with large language models is a huge and evolving topic. It is particularly important for AI applications:</p><ul><li>either for AI-native applications that strive to work around the shortcomings of current AI technology,</li><li>or for existing applications that seeks the integration of AI technology to improve performance, user interaction and experience, or efficiency.</li></ul><p>This guide will not delve into those discussions or which role an LLM should play in an application and the related best practice. Those views are reflected in the design of AI application frameworks: from LangChain to LlamaIndex to QwenAgent.</p><p>Instead, we will talk about how Qwen2.5 can be used to support function calling and how it can be used to achieve your goals, from the inference usage for developing application to the inner workings for hardcore customizations. In this guide,</p><ul><li>We will first demonstrate how to use function calling with Qwen2.5.</li><li>Then, we will introduce the technical details on functional calling with Qwen2.5, which are mainly about the templates.</li></ul><p>Before starting, there is one thing we have not yet introduced, that is ...</p><h2 id="what-is-function-calling" tabindex="-1">What is function calling? <a class="header-anchor" href="#what-is-function-calling" aria-label="Permalink to &quot;What is function calling?&quot;">​</a></h2><p>:::{Note} There is another term &quot;tool use&quot; that may be used to refer to the same concept. While some may argue that tools are a generalized form of functions, at present, their difference exists only technically as different I/O types of programming interfaces. :::</p><p>Large language models (LLMs) are powerful things. However, sometimes LLMs by themselves are simply not capable enough.</p><ul><li>On the one hand, LLMs have inherent modeling limitations. For one, they do not know things that are not in their training data, which include those happened after their training ended. In addition, they learn things in the way of likelihood, which suggests that they may not be precise enough for tasks with fixed rule sets, e.g., mathematical computation.</li><li>On the other hand, it is not easy to use LLMs as a Plug-and-Play service programmatically with other things. LLMs mostly talk in words that are open to interpretation and thus ambiguous, while other software or applications or systems talk in code and through programming interfaces that are pre-defined and fixed and structured.</li></ul><p>To this end, function calling establishes a common protocol that specifies how LLMs should interact with the other things. The procedure is mainly as follows:</p><ol><li>The application provides a set of functions and the instructions of the functions to an LLM.</li><li>The LLM choose to or not to, or is forced to use one or many of the functions, in response to user queries.</li><li>If the LLM chooses to use the functions, it states how the functions should be used based on the function instructions.</li><li>The chosen functions are used as such by the application and the results are obtained, which are then given to the LLM if further interaction is needed.</li></ol><p>They are many ways for LLMs to understand and follow this protocol. As always, the key is prompt engineering or an internalized template known by the model. Qwen2.5 were pre-trained with various types of templates that could support function calling, so that users can directly make use of this procedure.</p><h2 id="inference-with-function-calling" tabindex="-1">Inference with Function Calling <a class="header-anchor" href="#inference-with-function-calling" aria-label="Permalink to &quot;Inference with Function Calling&quot;">​</a></h2><p>:::{note} Please be aware that the inference usage is subject to change as the frameworks and the Qwen models evolve. :::</p><p>As function calling is essentially implemented using prompt engineering, you could manually construct the model inputs for Qwen2 models. However, frameworks with function calling support can help you with all that laborious work.</p><p>In the following, we will introduce the usage (via dedicated function calling chat template) with</p><ul><li><strong>Qwen-Agent</strong>,</li><li><strong>Hugging Face transformers</strong>,</li><li><strong>Ollama</strong>, and</li><li><strong>vLLM</strong>.</li></ul><p>If you are familiar with the usage of OpenAI API, you could also directly use the OpenAI-compatible API services for Qwen2.5. However, not all of them support function calling for Qwen2.5. Currently, supported solutions include the self-hosted service by <a href="https://github.com/ollama/ollama/blob/main/docs/openai.md" target="_blank" rel="noreferrer">Ollama</a> or <a href="https://docs.vllm.ai/en/stable/serving/openai_compatible_server.html#tool-calling-in-the-chat-completion-api" target="_blank" rel="noreferrer">vLLM</a> and the cloud service of <a href="https://help.aliyun.com/zh/model-studio/developer-reference/compatibility-of-openai-with-dashscope#97e2b45391x08" target="_blank" rel="noreferrer">ModelStudio [zh]</a>.</p><p>If you are familiar with application frameworks, e.g., LangChain, you can also use function calling abilities in Qwen2.5 via ReAct Prompting.</p><h3 id="the-example-case" tabindex="-1">The Example Case <a class="header-anchor" href="#the-example-case" aria-label="Permalink to &quot;The Example Case&quot;">​</a></h3><p>Let&#39;s also use an example to demonstrate the inference usage. We assume <strong>Python 3.11</strong> is used as the programming language.</p><p><strong>Scenario</strong>: Suppose we would like to ask the model about the temperature of a location. Normally, the model would reply that it cannot provide real-time information. But we have two tools that can be used to obtain the current temperature of and the temperature at a given date of a city respectively, and we would like the model to make use of them.</p><p>To set up the example case, you can use the following code:</p><p>:::{dropdown} Preparation Code :name: prepcode</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#B392F0;"> get_current_temperature</span><span style="color:#E1E4E8;">(location: </span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">, unit: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &quot;celsius&quot;</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;&quot;&quot;Get current temperature at a location.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="color:#9ECBFF;">        location: The location to get the temperature for, in the format &quot;City, State, Country&quot;.</span></span>
<span class="line"><span style="color:#9ECBFF;">        unit: The unit to return the temperature in. Defaults to &quot;celsius&quot;. (choices: [&quot;celsius&quot;, &quot;fahrenheit&quot;])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">    Returns:</span></span>
<span class="line"><span style="color:#9ECBFF;">        the temperature, the location, and the unit in a dict</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;temperature&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">26.1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;location&quot;</span><span style="color:#E1E4E8;">: location,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;unit&quot;</span><span style="color:#E1E4E8;">: unit,</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#B392F0;"> get_temperature_date</span><span style="color:#E1E4E8;">(location: </span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">, date: </span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">, unit: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &quot;celsius&quot;</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;&quot;&quot;Get temperature at a location and date.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="color:#9ECBFF;">        location: The location to get the temperature for, in the format &quot;City, State, Country&quot;.</span></span>
<span class="line"><span style="color:#9ECBFF;">        date: The date to get the temperature for, in the format &quot;Year-Month-Day&quot;.</span></span>
<span class="line"><span style="color:#9ECBFF;">        unit: The unit to return the temperature in. Defaults to &quot;celsius&quot;. (choices: [&quot;celsius&quot;, &quot;fahrenheit&quot;])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">    Returns:</span></span>
<span class="line"><span style="color:#9ECBFF;">        the temperature, the location, the date and the unit in a dict</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;temperature&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">25.9</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;location&quot;</span><span style="color:#E1E4E8;">: location,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;date&quot;</span><span style="color:#E1E4E8;">: date,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;unit&quot;</span><span style="color:#E1E4E8;">: unit,</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#B392F0;"> get_function_by_name</span><span style="color:#E1E4E8;">(name):</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> name </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;get_current_temperature&quot;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> get_current_temperature</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> name </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;get_temperature_date&quot;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> get_temperature_date</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">TOOLS</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;function&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">            &quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;get_current_temperature&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">            &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Get current temperature at a location.&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">            &quot;parameters&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;object&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;properties&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                    &quot;location&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;The location to get the temperature for, in the format &quot;City, State, Country&quot;.&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    },</span></span>
<span class="line"><span style="color:#9ECBFF;">                    &quot;unit&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;enum&quot;</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;celsius&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;fahrenheit&quot;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;The unit to return the temperature in. Defaults to &quot;celsius&quot;.&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    },</span></span>
<span class="line"><span style="color:#E1E4E8;">                },</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;required&quot;</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;location&quot;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">            },</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;function&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">            &quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;get_temperature_date&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">            &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Get temperature at a location and date.&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">            &quot;parameters&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;object&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;properties&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                    &quot;location&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;The location to get the temperature for, in the format &quot;City, State, Country&quot;.&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    },</span></span>
<span class="line"><span style="color:#9ECBFF;">                    &quot;date&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;The date to get the temperature for, in the format &quot;Year-Month-Day&quot;.&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    },</span></span>
<span class="line"><span style="color:#9ECBFF;">                    &quot;unit&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;enum&quot;</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;celsius&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;fahrenheit&quot;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#9ECBFF;">                        &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;The unit to return the temperature in. Defaults to &quot;celsius&quot;.&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    },</span></span>
<span class="line"><span style="color:#E1E4E8;">                },</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;required&quot;</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;location&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;date&quot;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">            },</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#79B8FF;">MESSAGES</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;content&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">Current Date: 2024-09-30&quot;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;user&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#9ECBFF;">&quot;content&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;What&#39;s the temperature in San Francisco now? How about tomorrow?&quot;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><p>:::</p><p>In particular, the tools should be described using JSON Schema and the messages should contain as much available information as possible. You can find the explanations of the tools and messages below:</p><p>:::{dropdown} Example Tools</p><p>The tools should be described using the following JSON:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;function&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">      &quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;get_current_temperature&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">      &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Get current temperature at a location.&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">      &quot;parameters&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;object&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">        &quot;properties&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">          &quot;location&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;The location to get the temperature for, in the format </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">City, State, Country</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          },</span></span>
<span class="line"><span style="color:#79B8FF;">          &quot;unit&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;enum&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#9ECBFF;">              &quot;celsius&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">              &quot;fahrenheit&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            ],</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;The unit to return the temperature in. Defaults to </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">celsius</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          }</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#79B8FF;">        &quot;required&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#9ECBFF;">          &quot;location&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ]</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;function&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">      &quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;get_temperature_date&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">      &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Get temperature at a location and date.&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">      &quot;parameters&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">        &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;object&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">        &quot;properties&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">          &quot;location&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;The location to get the temperature for, in the format </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">City, State, Country</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          },</span></span>
<span class="line"><span style="color:#79B8FF;">          &quot;date&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;The date to get the temperature for, in the format </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">Year-Month-Day</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          },</span></span>
<span class="line"><span style="color:#79B8FF;">          &quot;unit&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;string&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;enum&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#9ECBFF;">              &quot;celsius&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">              &quot;fahrenheit&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            ],</span></span>
<span class="line"><span style="color:#79B8FF;">            &quot;description&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;The unit to return the temperature in. Defaults to </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">celsius</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          }</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#79B8FF;">        &quot;required&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#9ECBFF;">          &quot;location&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">          &quot;date&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ]</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><p>For each <strong>tool</strong>, it is a JSON object with two fields:</p><ul><li><code>type</code>: a string specifying the type of the tool, currently only <code>&quot;function&quot;</code> is valid</li><li><code>function</code>: an object detailing the instructions to use the function</li></ul><p>For each <strong>function</strong>, it is a JSON object with three fields:</p><ul><li><code>name</code>: a string indicating the name of the function</li><li><code>description</code>: a string describing what the function is used for</li><li><code>parameters</code>: <a href="https://json-schema.org/learn/getting-started-step-by-step" target="_blank" rel="noreferrer">a JSON Schema</a> that specifies the parameters the function accepts. Please refer to the linked documentation for how to compose a JSON Schema. Notable fields include <code>type</code>, <code>required</code>, and <code>enum</code>.</li></ul><p>Most frameworks use the tool format and some may use the function format. Which one to use should be obvious according to the naming. :::</p><p>:::{dropdown} Example Messages</p><p>Our query is <code>What&#39;s the temperature in San Francisco now? How about tomorrow?</code>. Since the model does not know what the current date is, let alone tomorrow, we should provide the date in the inputs. Here, we decide to supply that information in the system message after the default system message <code>You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</code>. You could append the date to user message in your application code.</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#79B8FF;">&quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;content&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">Current Date: 2024-09-30&quot;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#79B8FF;">&quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;user&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">&quot;content&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;What&#39;s the temperature in San Francisco now? How about tomorrow?&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><p>:::</p><h3 id="qwen-agent" tabindex="-1">Qwen-Agent <a class="header-anchor" href="#qwen-agent" aria-label="Permalink to &quot;Qwen-Agent&quot;">​</a></h3><p><a href="https://github.com/QwenLM/Qwen-Agent" target="_blank" rel="noreferrer">Qwen-Agent</a> is actually a Python Agent framework for developing AI applications. Although its intended use cases are higher-level than efficient inference, it does contain the <strong>canonical implementation</strong> of function calling for Qwen2.5. It provides the function calling ability for Qwen2.5 to an OpenAI-compatible API through templates that is transparent to users.</p><p>{#note-official-template} It&#39;s worth noting that since a lot of stuff can be done under the scene with application frameworks, currently the official function calling implementation for Qwen2.5 is very flexible and beyond simple templating, making it hard to adapt it other frameworks that use less capable templating engines.</p><p>Before starting, let&#39;s make sure the latest library is installed:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">pip</span><span style="color:#9ECBFF;"> install</span><span style="color:#79B8FF;"> -U</span><span style="color:#9ECBFF;"> qwen-agent</span></span></code></pre></div><p>For this guide, we are at version v0.0.10.</p><h4 id="preparing" tabindex="-1">Preparing <a class="header-anchor" href="#preparing" aria-label="Permalink to &quot;Preparing&quot;">​</a></h4><p>Qwen-Agent can wrap an OpenAI-compatible API that does not support function calling. You can serve such an API with most inference frameworks or obtain one from cloud providers like DashScope or Together.</p><p>Assuming there is an OpenAI-compatible API at <code>http://localhost:8000/v1</code>, Qwen-Agent provides a shortcut function <code>get_chat_model</code> to obtain a model inference class with function calling support:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> qwen_agent.llm </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> get_chat_model</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">llm </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> get_chat_model({</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;model&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Qwen/Qwen2.5-7B-Instruct&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;model_server&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;http://localhost:8000/v1&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;api_key&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;EMPTY&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><p>In the above, <code>model_server</code> is the <code>api_base</code> common used in other OpenAI-compatible API clients. It is advised to provide the <code>api_key</code> (but not via plaintext in the code), even if the API server does not check it, in which case, you can set it to anything.</p><p>For model inputs, the common message structure for system, user, and assistant history should be used:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">messages </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> MESSAGES</span><span style="color:#E1E4E8;">[:]</span></span>
<span class="line"><span style="color:#6A737D;"># [</span></span>
<span class="line"><span style="color:#6A737D;">#    {&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.\\n\\nCurrent Date: 2024-09-30&quot;},</span></span>
<span class="line"><span style="color:#6A737D;">#    {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What&#39;s the temperature in San Francisco now? How about tomorrow?&quot;}</span></span>
<span class="line"><span style="color:#6A737D;"># ]</span></span></code></pre></div><p>We add the current date to the system message so that the &quot;tomorrow&quot; in the user message is anchored. It can also be added to the user message if one desires.</p><p>At the time, Qwen-Agent works with functions instead of tools. This requires a small change to our tool descriptions, that is, extracting the function fields:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">functions </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [tool[</span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> tool </span><span style="color:#F97583;">in</span><span style="color:#79B8FF;"> TOOLS</span><span style="color:#E1E4E8;">]</span></span></code></pre></div><h4 id="tool-calls-and-tool-results" tabindex="-1">Tool Calls and Tool Results <a class="header-anchor" href="#tool-calls-and-tool-results" aria-label="Permalink to &quot;Tool Calls and Tool Results&quot;">​</a></h4><p>To interact with the model, the <code>chat</code> method should be used:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> responses </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> llm.chat(</span></span>
<span class="line"><span style="color:#FFAB70;">    messages</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">messages,</span></span>
<span class="line"><span style="color:#FFAB70;">    functions</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">functions,</span></span>
<span class="line"><span style="color:#FFAB70;">    extra_generate_cfg</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">dict</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">parallel_function_calls</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">True</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#F97583;">    pass</span></span>
<span class="line"><span style="color:#E1E4E8;">messages.extend(responses)</span></span></code></pre></div><p>In the above code, the <code>chat</code> method receives the <code>messages</code>, the <code>functions</code>, and an <code>extra_generate_cfg</code> parameter. You can put sampling parameters, such as <code>temperature</code>, and <code>top_p</code>, in the <code>extra_generate_cfg</code>. Here, we add to it a special control <code>parallel_function_calls</code> provided by Qwen-Agent. As its name suggests, it will enable parallel function calls, which means that the model may generate multiple function calls for a single turn as it deems fit.</p><p>The <code>chat</code> method returns a generator of list, each of which may contain multiple messages. Since we enable <code>parallel_function_calls</code>, we should get two messages in the responses:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function_call&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">}},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function_call&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">}},</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><p>As we can see, Qwen-Agent attempts to parse the model generation in an easier to use structural format. The details related to function calls are placed in the <code>function_call</code> field of the messages:</p><ul><li><code>name</code>: a string representing the function to call</li><li><code>arguments</code>: a JSON-formatted string representing the arguments the function should be called with</li></ul><p>Note that Qwen2.5-7B-Instruct is quite capable:</p><ul><li>It has followed the function instructions to add the state and the country to the location.</li><li>It has correctly induced the date of tomorrow and given in the format required by the function.</li></ul><p>Then comes the critical part -- checking and applying the function call:</p><div class="language-python3"><button title="Copy Code" class="copy"></button><span class="lang">python3</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>for message in responses:</span></span>
<span class="line"><span>    if fn_call := message.get(&quot;function_call&quot;, None):</span></span>
<span class="line"><span>        fn_name: str = fn_call[&#39;name&#39;]</span></span>
<span class="line"><span>        fn_args: dict = json.loads(fn_call[&quot;arguments&quot;])</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        fn_res: str = json.dumps(get_function_by_name(fn_name)(**fn_args))</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        messages.append({</span></span>
<span class="line"><span>            &quot;role&quot;: &quot;function&quot;,</span></span>
<span class="line"><span>            &quot;name&quot;: fn_name,</span></span>
<span class="line"><span>            &quot;content&quot;: fn_res,</span></span>
<span class="line"><span>        })</span></span></code></pre></div><p>To get tool results:</p><ul><li>line 1: We should iterate the function calls in the order the model generates them.</li><li>line 2: We can check if a function call is needed as deemed by the model by checking the <code>function_call</code> field of the generated messages.</li><li>line 3-4: The related details including the name and the arguments of the function can also be found there, which are <code>name</code> and <code>arguments</code> respectively.</li><li>line 6: With the details, one should call the function and obtain the results. Here, we assume there is a function named <a href="#prepcode"><code>get_function_by_name</code></a> to help us get the related function by its name.</li><li>line 8-12: With the result obtained, add the function result to the messages as <code>content</code> and with <code>role</code> as <code>&quot;function&quot;</code>.</li></ul><p>Now the messages are</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;system&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">Current Date: 2024-09-30&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;user&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;What&#39;s the temperature in San Francisco now? How about tomorrow?&quot;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function_call&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">}},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function_call&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">}},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;temperature&quot;: 26.1, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;temperature&quot;: 25.9, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><h4 id="final-response" tabindex="-1">Final Response <a class="header-anchor" href="#final-response" aria-label="Permalink to &quot;Final Response&quot;">​</a></h4><p>Finally, run the model again to get the final model results:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> responses </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> llm.chat(</span><span style="color:#FFAB70;">messages</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">messages, </span><span style="color:#FFAB70;">functions</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">functions):</span></span>
<span class="line"><span style="color:#F97583;">    pass</span></span>
<span class="line"><span style="color:#E1E4E8;">messages.extend(responses)</span></span></code></pre></div><p>The final response should be like</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;Currently, the temperature in San Francisco is approximately 26.1°C. Tomorrow, on 2024-10-01, the temperature is forecasted to be around 25.9°C.&#39;</span><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="hugging-face-transformers" tabindex="-1">Hugging Face transformers <a class="header-anchor" href="#hugging-face-transformers" aria-label="Permalink to &quot;Hugging Face transformers&quot;">​</a></h3><p>Since function calling is based on prompt engineering and templates, <code>transformers</code> supports it with its tokenizer utilities, in particular, the <code>tokenizer.apply_chat_template</code> method, which hides the sophistication of constructing the model inputs, using the Jinja templating engine. However, it means that users should handle the model output part on their own, which includes parsing the generated function call message.</p><p>The blog piece <a href="https://huggingface.co/blog/unified-tool-use" target="_blank" rel="noreferrer"><em>Tool Use, Unified</em></a> is very helpful in understanding its design. Be sure to take a look.</p><p>Tool use API is available in transformers since v4.42.0. Before starting, let&#39;s check that:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">pip</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> &quot;transformers&gt;4.42.0&quot;</span></span></code></pre></div><p>For this guide, we are at version v4.44.2.</p><h4 id="preparing-1" tabindex="-1">Preparing <a class="header-anchor" href="#preparing-1" aria-label="Permalink to &quot;Preparing&quot;">​</a></h4><p>For Qwen2.5, the chat template in <code>tokenizer_config.json</code> has already included support for the Hermes-style tool use. We simply need to load the model and the tokenizer:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> transformers </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> AutoModelForCausalLM, AutoTokenizer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">model_name_or_path </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;Qwen/Qwen2.5-7B-Instruct&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">tokenizer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> AutoTokenizer.from_pretrained(model_name_or_path)</span></span>
<span class="line"><span style="color:#E1E4E8;">model </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> AutoModelForCausalLM.from_pretrained(</span></span>
<span class="line"><span style="color:#E1E4E8;">    model_name_or_path,</span></span>
<span class="line"><span style="color:#FFAB70;">    torch_dtype</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;auto&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#FFAB70;">    device_map</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;auto&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre></div><p>The inputs are the same with those in <a href="#prepcode">the preparation code</a>:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">tools </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> TOOLS</span></span>
<span class="line"><span style="color:#E1E4E8;">messages </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> MESSAGES</span><span style="color:#E1E4E8;">[:]</span></span></code></pre></div><p>In <code>transformers</code>, you can also directly use Python functions as tools with certain constraints[^get_json_schema_note]:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">tools </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [get_current_temperature, get_temperature_date]</span></span></code></pre></div><p>[^get_json_schema_note]: <code>transformers</code> will use <code>transformers.utils.get_json_schema</code> to generate the tool descriptions from Python functions. There are some gotchas with <code>get_json_schema</code>, and it is advised to check <a href="https://github.com/huggingface/transformers/blob/v4.44.2/src/transformers/utils/chat_template_utils.py#L183-L288" target="_blank" rel="noreferrer">its doc [v4.44.2]</a> before relying on it.</p><pre><code>- The function should use Python type hints for parameter types and has a Google-style docstring for function description and parameter descriptions.
- Supported types are limited, since the types needs to be mapped to JSON Schema.
  In particular, \`typing.Literal\` is not supported.
  You can instead add \`(choices: ...)\` at the end of a parameter description, which will be mapped to a \`enum\` type in JSON Schema.

Please be aware that all the returned results in the examples in the linked docstring are actually the content of the \`function\` field in the actual returned results.
</code></pre><h4 id="tool-calls-and-tool-results-1" tabindex="-1">Tool Calls and Tool Results <a class="header-anchor" href="#tool-calls-and-tool-results-1" aria-label="Permalink to &quot;Tool Calls and Tool Results&quot;">​</a></h4><p>To construct the input sequence, we should use the <code>apply_chat_template</code> method and then let the model continue the texts:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tokenizer.apply_chat_template(messages, </span><span style="color:#FFAB70;">tools</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">tools, </span><span style="color:#FFAB70;">add_generation_prompt</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">True</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">tokenize</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">False</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">inputs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tokenizer(text, </span><span style="color:#FFAB70;">return_tensors</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;pt&quot;</span><span style="color:#E1E4E8;">).to(model.device)</span></span>
<span class="line"><span style="color:#E1E4E8;">outputs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> model.generate(</span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">inputs, </span><span style="color:#FFAB70;">max_new_tokens</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">512</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">output_text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tokenizer.batch_decode(outputs)[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">][</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(text):]</span></span></code></pre></div><p>The output texts should be like</p><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;tool_call&gt;</span></span>
<span class="line"><span>{&quot;name&quot;: &quot;get_current_temperature&quot;, &quot;arguments&quot;: {&quot;location&quot;: &quot;San Francisco, CA, USA&quot;}}</span></span>
<span class="line"><span>&lt;/tool_call&gt;</span></span>
<span class="line"><span>&lt;tool_call&gt;</span></span>
<span class="line"><span>{&quot;name&quot;: &quot;get_temperature_date&quot;, &quot;arguments&quot;: {&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;}}</span></span>
<span class="line"><span>&lt;/tool_call&gt;&lt;|im_end|&gt;</span></span></code></pre></div><p>Now we need to do two things:</p><ol><li>Parse the generated tool calls to a message and add them to the messages, so that the model knows which tools are used.</li><li>Obtain the results of the tools and add them to the messages, so that the model knows the results of the tool calls.</li></ol><p>In <code>transformers</code>, the tool calls should be a field of assistant messages. Let&#39;s use a simple function called <code>try_parse_tool_calls</code> to parse the tool calls:</p><p id="parse-function"></p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> re</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#B392F0;"> try_parse_tool_calls</span><span style="color:#E1E4E8;">(content: </span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;&quot;&quot;Try parse the tool calls.&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    tool_calls </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> []</span></span>
<span class="line"><span style="color:#E1E4E8;">    offset </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> i, m </span><span style="color:#F97583;">in</span><span style="color:#79B8FF;"> enumerate</span><span style="color:#E1E4E8;">(re.finditer(</span><span style="color:#F97583;">r</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#DBEDFF;">&lt;tool_call&gt;</span><span style="color:#85E89D;font-weight:bold;">\\n</span><span style="color:#79B8FF;">(.</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">)</span><span style="color:#F97583;">?</span><span style="color:#85E89D;font-weight:bold;">\\n</span><span style="color:#DBEDFF;">&lt;/tool_call&gt;</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, content)):</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">==</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            offset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> m.start()</span></span>
<span class="line"><span style="color:#F97583;">        try</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            func </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> json.loads(m.group(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">            tool_calls.append({</span><span style="color:#9ECBFF;">&quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">: func})</span></span>
<span class="line"><span style="color:#F97583;">            if</span><span style="color:#79B8FF;"> isinstance</span><span style="color:#E1E4E8;">(func[</span><span style="color:#9ECBFF;">&quot;arguments&quot;</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">                func[</span><span style="color:#9ECBFF;">&quot;arguments&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> json.loads(func[</span><span style="color:#9ECBFF;">&quot;arguments&quot;</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#F97583;">        except</span><span style="color:#E1E4E8;"> json.JSONDecodeError </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> e:</span></span>
<span class="line"><span style="color:#79B8FF;">            print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;Failed to parse tool calls: the content is </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">m.group(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;"> and </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">e</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">            pass</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> tool_calls:</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> offset </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#F97583;"> and</span><span style="color:#E1E4E8;"> content[:offset].strip():</span></span>
<span class="line"><span style="color:#E1E4E8;">            c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> content[:offset]</span></span>
<span class="line"><span style="color:#F97583;">        else</span><span style="color:#E1E4E8;">: </span></span>
<span class="line"><span style="color:#E1E4E8;">            c </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> {</span><span style="color:#9ECBFF;">&quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;assistant&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;content&quot;</span><span style="color:#E1E4E8;">: c, </span><span style="color:#9ECBFF;">&quot;tool_calls&quot;</span><span style="color:#E1E4E8;">: tool_calls}</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span><span style="color:#9ECBFF;">&quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;assistant&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;content&quot;</span><span style="color:#E1E4E8;">: re.sub(</span><span style="color:#F97583;">r</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#DBEDFF;">&lt;</span><span style="color:#85E89D;font-weight:bold;">\\|</span><span style="color:#DBEDFF;">im_end</span><span style="color:#85E89D;font-weight:bold;">\\|</span><span style="color:#DBEDFF;">&gt;</span><span style="color:#79B8FF;">$</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">, content)}</span></span></code></pre></div><p>This function does not cover all possible scenarios and thus is prone to errors. But it should suffice for the purpose of this guide.</p><p>:::{note} The template in the <code>tokenizer_config.json</code> assumes that the generated content alongside tool calls is in the same message instead of separate assistant messages, e.g.,</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#79B8FF;">  &quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;assistant&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">  &quot;content&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;To obtain the current temperature, I should call the functions \`get_current_temperate\`.&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">  &quot;tool_calls&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#79B8FF;">&quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;function&quot;</span><span style="color:#E1E4E8;">: {</span><span style="color:#79B8FF;">&quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;get_current_temperature&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;arguments&quot;</span><span style="color:#E1E4E8;">: {</span><span style="color:#79B8FF;">&quot;location&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;San Francisco, CA, USA&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;unit&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;celsius&quot;</span><span style="color:#E1E4E8;">}}}</span></span>
<span class="line"><span style="color:#E1E4E8;">  ]</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>instead of</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;assistant&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;content&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;To obtain the current temperature, I should call the functions \`get_current_temperate\`.&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  {</span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;assistant&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;content&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">    &quot;tool_calls&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">      {</span><span style="color:#79B8FF;">&quot;type&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;function&quot;</span><span style="color:#E1E4E8;">: {</span><span style="color:#79B8FF;">&quot;name&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;get_current_temperature&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;arguments&quot;</span><span style="color:#E1E4E8;">: {</span><span style="color:#79B8FF;">&quot;location&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;San Francisco, CA, USA&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">&quot;unit&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;celsius&quot;</span><span style="color:#E1E4E8;">}}}</span></span>
<span class="line"><span style="color:#E1E4E8;">    ]</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><p>This is implemented roughly in <code>try_parse_tool_calls</code> but keep that in mind if you are writing your own tool call parser. :::</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">messages.append(try_parse_tool_calls(output_text))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> tool_calls </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> messages[</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].get(</span><span style="color:#9ECBFF;">&quot;tool_calls&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> tool_call </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> tool_calls:</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> fn_call </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> tool_call.get(</span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">            fn_name: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> fn_call[</span><span style="color:#9ECBFF;">&quot;name&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">            fn_args: </span><span style="color:#79B8FF;">dict</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> fn_call[</span><span style="color:#9ECBFF;">&quot;arguments&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            fn_res: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> json.dumps(get_function_by_name(fn_name)(</span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">fn_args))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            messages.append({</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;tool&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;name&quot;</span><span style="color:#E1E4E8;">: fn_name,</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;content&quot;</span><span style="color:#E1E4E8;">: fn_res,</span></span>
<span class="line"><span style="color:#E1E4E8;">            })</span></span></code></pre></div><p>The messages now should be like</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;system&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">Current Date: 2024-09-30&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;user&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;What&#39;s the temperature in San Francisco now? How about tomorrow?&quot;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tool_calls&#39;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span><span style="color:#9ECBFF;">&#39;type&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;location&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;San Francisco, CA, USA&#39;</span><span style="color:#E1E4E8;">}}}, </span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span><span style="color:#9ECBFF;">&#39;type&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;location&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;San Francisco, CA, USA&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;date&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;2024-10-01&#39;</span><span style="color:#E1E4E8;">}}},</span></span>
<span class="line"><span style="color:#E1E4E8;">    ]},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;tool&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;temperature&quot;: 26.1, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;tool&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;temperature&quot;: 25.9, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><p>The messages are similar to those of Qwen-Agent, but there are some major differences:</p><ul><li>Tools instead of functions</li><li>Parallel calls are by default <ul><li>Multiple tool calls as a list in a single assistant message, instead of multiple messages.</li><li>The function arguments are parsed into a dict if it is a valid JSON-formatted string.</li></ul></li></ul><h4 id="final-response-1" tabindex="-1">Final Response <a class="header-anchor" href="#final-response-1" aria-label="Permalink to &quot;Final Response&quot;">​</a></h4><p>Then it&#39;s time for the model to generate the actual response for us based on the tool results. Let&#39;s query the model again:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tokenizer.apply_chat_template(messages, </span><span style="color:#FFAB70;">tools</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">tools, </span><span style="color:#FFAB70;">add_generation_prompt</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">True</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">tokenize</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">False</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">inputs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tokenizer(text, </span><span style="color:#FFAB70;">return_tensors</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;pt&quot;</span><span style="color:#E1E4E8;">).to(model.device)</span></span>
<span class="line"><span style="color:#E1E4E8;">outputs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> model.generate(</span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">inputs, </span><span style="color:#FFAB70;">max_new_tokens</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">512</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">output_text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tokenizer.batch_decode(outputs)[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">][</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(text):]</span></span></code></pre></div><p>The output_text should be like</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>The current temperature in San Francisco is approximately 26.1°C. Tomorrow, on October 1, 2024, the temperature is expected to be around 25.9°C.&lt;|im_end|&gt;</span></span></code></pre></div><p>Add the result text as an assistant message and the final messages should be ready for further interaction:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">messages.append(try_parse_tool_calls(output_text))</span></span></code></pre></div><h3 id="ollama" tabindex="-1">Ollama <a class="header-anchor" href="#ollama" aria-label="Permalink to &quot;Ollama&quot;">​</a></h3><p>Ollama is a set of tools for serving LLMs locally. It also relies on its template implementation to support function calling. Different from transformers, which is written in Python and uses the Jinja template whose syntax is heavily inspired by Django and Python, Ollama, which is mostly written in Go, uses Go&#39;s <a href="https://pkg.go.dev/text/template" target="_blank" rel="noreferrer">text/template</a> packages. In addition, Ollama implements internally a helper function so that it can automatically parse the generated tool calls in texts to structured messages if the format supported.</p><p>You could check the <a href="https://ollama.com/blog/tool-support" target="_blank" rel="noreferrer">Tool support</a> blog post first.</p><p>Tool support has been available in Ollama since v0.3.0. You can run the following to check the Ollama version:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">ollama</span><span style="color:#79B8FF;"> -v</span></span></code></pre></div><p>If lower than expected, follow <a href="https://ollama.com/download" target="_blank" rel="noreferrer">the official instructions</a> to install the latest version.</p><p>In this guide, we will aslo use <a href="https://github.com/ollama/ollama-python" target="_blank" rel="noreferrer">ollama-python</a>, before starting, make sure it is available in your environment:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">pip</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> ollama</span></span></code></pre></div><p>For this guide, the <code>ollama</code> binary is at v0.3.9 and the <code>ollama</code> Python library is at v0.3.2.</p><h4 id="preparing-2" tabindex="-1">Preparing <a class="header-anchor" href="#preparing-2" aria-label="Permalink to &quot;Preparing&quot;">​</a></h4><p>The messages structure used in Ollama is the same with that in <code>transformers</code> and the template in <a href="https://ollama.com/library/qwen2.5" target="_blank" rel="noreferrer">Qwen2.5 Ollama models</a> has supported tool use.</p><p>The inputs are the same with those in <a href="#prepcode">the preparation code</a>:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">tools </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> TOOLS</span></span>
<span class="line"><span style="color:#E1E4E8;">messages </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> MESSAGES</span><span style="color:#E1E4E8;">[:]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">model_name </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;qwen2.5:7b&quot;</span></span></code></pre></div><p>Note that you cannot pass Python functions as tools directly and <code>tools</code> has to be a <code>dict</code>.</p><h4 id="tool-calls-and-tool-results-2" tabindex="-1">Tool Calls and Tool Results <a class="header-anchor" href="#tool-calls-and-tool-results-2" aria-label="Permalink to &quot;Tool Calls and Tool Results&quot;">​</a></h4><p>We can use the <code>ollama.chat</code> method to directly query the underlying API:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> ollama</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">response </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ollama.chat(</span></span>
<span class="line"><span style="color:#FFAB70;">    model</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">model_name,</span></span>
<span class="line"><span style="color:#FFAB70;">    messages</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">messages,</span></span>
<span class="line"><span style="color:#FFAB70;">    tools</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">tools,</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre></div><p>The main fields in the response could be:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;model&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;qwen2.5:7b&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;message&#39;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">        &#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">        &#39;tool_calls&#39;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">            {</span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;location&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;San Francisco, CA, USA&#39;</span><span style="color:#E1E4E8;">}}},</span></span>
<span class="line"><span style="color:#E1E4E8;">            {</span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;date&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;2024-10-01&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;location&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;San Francisco, CA, USA&#39;</span><span style="color:#E1E4E8;">}}},</span></span>
<span class="line"><span style="color:#E1E4E8;">        ],</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>Ollama&#39;s tool call parser has succeeded in parsing the tool results. If not, you may refine <a href="#parse-function">the <code>try_parse_tool_calls</code> function above</a>. Then, we can obtain the tool results and add them to the messages. The following is basically the same with <code>transformers</code>:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">messages.append(response[</span><span style="color:#9ECBFF;">&quot;message&quot;</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> tool_calls </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> messages[</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].get(</span><span style="color:#9ECBFF;">&quot;tool_calls&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> tool_call </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> tool_calls:</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> fn_call </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> tool_call.get(</span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">            fn_name: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> fn_call[</span><span style="color:#9ECBFF;">&quot;name&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">            fn_args: </span><span style="color:#79B8FF;">dict</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> fn_call[</span><span style="color:#9ECBFF;">&quot;arguments&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            fn_res: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> json.dumps(get_function_by_name(fn_name)(</span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">fn_args))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            messages.append({</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;tool&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;name&quot;</span><span style="color:#E1E4E8;">: fn_name,</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;content&quot;</span><span style="color:#E1E4E8;">: fn_res,</span></span>
<span class="line"><span style="color:#E1E4E8;">            })</span></span></code></pre></div><p>The messages are now like</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;system&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">Current Date: 2024-09-30&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;user&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;What&#39;s the temperature in San Francisco now? How about tomorrow?&quot;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tool_calls&#39;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;location&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;San Francisco, CA, USA&#39;</span><span style="color:#E1E4E8;">}}},</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;date&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;2024-10-01&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;location&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;San Francisco, CA, USA&#39;</span><span style="color:#E1E4E8;">}}},</span></span>
<span class="line"><span style="color:#E1E4E8;">    ]},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;tool&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;temperature&quot;: 26.1, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;tool&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;temperature&quot;: 25.9, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><h4 id="final-response-2" tabindex="-1">Final Response <a class="header-anchor" href="#final-response-2" aria-label="Permalink to &quot;Final Response&quot;">​</a></h4><p>The rest are easy:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">response </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ollama.chat(</span></span>
<span class="line"><span style="color:#FFAB70;">    model</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">model_name,</span></span>
<span class="line"><span style="color:#FFAB70;">    messages</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">messages,</span></span>
<span class="line"><span style="color:#FFAB70;">    tools</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">tools,</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">messages.append(response[</span><span style="color:#9ECBFF;">&quot;message&quot;</span><span style="color:#E1E4E8;">])</span></span></code></pre></div><p>The final message should be like the following:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;The current temperature in San Francisco is approximately 26.1°C. For tomorrow, October 1st, 2024, the forecasted temperature will be around 25.9°C.&#39;</span><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>(heading-target)=</p><h3 id="vllm" tabindex="-1">vLLM <a class="header-anchor" href="#vllm" aria-label="Permalink to &quot;vLLM&quot;">​</a></h3><p>vLLM is a fast and easy-to-use library for LLM inference and serving. It uses the tokenizer from <code>transformers</code> to format the input, so we should have no trouble preparing the input. In addition, vLLm also implements helper functions so that generated tool calls can be parsed automatically if the format is supported.</p><p>Tool support has been available in <code>vllm</code> since v0.6.0. Be sure to install a version that supports tool use. For more information, check the <a href="https://docs.vllm.ai/en/stable/serving/openai_compatible_server.html#tool-calling-in-the-chat-completion-api" target="_blank" rel="noreferrer">vLLM documentation</a>.</p><p>For this guide, we are at version v0.6.1.post2. We will use the OpenAI-Compatible API by <code>vllm</code> with the API client from the <code>openai</code> Python library.</p><h4 id="preparing-3" tabindex="-1">Preparing <a class="header-anchor" href="#preparing-3" aria-label="Permalink to &quot;Preparing&quot;">​</a></h4><p>For Qwen2.5, the chat template in tokenizer_config.json has already included support for the Hermes-style tool use. We simply need to start a OpenAI-compatible API with vLLM:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">vllm</span><span style="color:#9ECBFF;"> serve</span><span style="color:#9ECBFF;"> Qwen/Qwen2.5-7B-Instruct</span><span style="color:#79B8FF;"> --enable-auto-tool-choice</span><span style="color:#79B8FF;"> --tool-call-parser</span><span style="color:#9ECBFF;"> hermes</span></span></code></pre></div><p>The inputs are the same with those in <a href="#prepcode">the preparation code</a>:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">tools </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> TOOLS</span></span>
<span class="line"><span style="color:#E1E4E8;">messages </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> MESSAGES</span><span style="color:#E1E4E8;">[:]</span></span></code></pre></div><p>Let&#39;s also initialize the client:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> openai </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> OpenAI</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">openai_api_key </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;EMPTY&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">openai_api_base </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;http://localhost:8000/v1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">client </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> OpenAI(</span></span>
<span class="line"><span style="color:#FFAB70;">    api_key</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">openai_api_key,</span></span>
<span class="line"><span style="color:#FFAB70;">    base_url</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">openai_api_base,</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">model_name </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;Qwen/Qwen2.5-7B-Instruct&quot;</span></span></code></pre></div><h4 id="tool-calls-and-tool-results-3" tabindex="-1">Tool Calls and Tool Results <a class="header-anchor" href="#tool-calls-and-tool-results-3" aria-label="Permalink to &quot;Tool Calls and Tool Results&quot;">​</a></h4><p>We can use the create chat completions endpoint to query the model:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">response </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> client.chat.completions.create(</span></span>
<span class="line"><span style="color:#FFAB70;">    model</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">model_name,</span></span>
<span class="line"><span style="color:#FFAB70;">    messages</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">messages,</span></span>
<span class="line"><span style="color:#FFAB70;">    tools</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">tools,</span></span>
<span class="line"><span style="color:#FFAB70;">    temperature</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.7</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#FFAB70;">    top_p</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.8</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#FFAB70;">    max_tokens</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">512</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#FFAB70;">    extra_body</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;repetition_penalty&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1.05</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre></div><p>vLLM should be able to parse the tool calls for us, and the main fields in the response (<code>response.choices[0]</code>) should be like</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">Choice(</span></span>
<span class="line"><span style="color:#FFAB70;">    finish_reason</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;tool_calls&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#FFAB70;">    index</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#FFAB70;">    logprobs</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#FFAB70;">    message</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ChatCompletionMessage(</span></span>
<span class="line"><span style="color:#FFAB70;">        content</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#FFAB70;">        role</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#FFAB70;">        function_call</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#FFAB70;">        tool_calls</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">            ChatCompletionMessageToolCall(</span></span>
<span class="line"><span style="color:#FFAB70;">                id</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;chatcmpl-tool-924d705adb044ff88e0ef3afdd155f15&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#FFAB70;">                function</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">Function(</span><span style="color:#FFAB70;">arguments</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;{&quot;location&quot;: &quot;San Francisco, CA, USA&quot;}&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">), </span></span>
<span class="line"><span style="color:#FFAB70;">                type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            ), </span></span>
<span class="line"><span style="color:#E1E4E8;">            ChatCompletionMessageToolCall(</span></span>
<span class="line"><span style="color:#FFAB70;">                id</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;chatcmpl-tool-7e30313081944b11b6e5ebfd02e8e501&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#FFAB70;">                function</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">Function(</span><span style="color:#FFAB70;">arguments</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;{&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;}&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">), </span></span>
<span class="line"><span style="color:#FFAB70;">                type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            ),</span></span>
<span class="line"><span style="color:#E1E4E8;">        ],</span></span>
<span class="line"><span style="color:#E1E4E8;">    ), </span></span>
<span class="line"><span style="color:#FFAB70;">    stop_reason</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre></div><p>Note that the function arguments are JSON-formatted strings, which Qwen-Agent follows but <code>transformers</code> and Ollama differs.</p><p>As before, chances are that there are corner cases where tool calls are generated but they are malformed and cannot be parsed. For production code, we should try parsing by ourselves.</p><p>Then, we can obtain the tool results and add them to the messages as shown below:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">messages.append(response.choices[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].message.model_dump())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> tool_calls </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> messages[</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].get(</span><span style="color:#9ECBFF;">&quot;tool_calls&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> tool_call </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> tool_calls:</span></span>
<span class="line"><span style="color:#E1E4E8;">        call_id: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> tool_call[</span><span style="color:#9ECBFF;">&quot;id&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> fn_call </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> tool_call.get(</span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">            fn_name: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> fn_call[</span><span style="color:#9ECBFF;">&quot;name&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">            fn_args: </span><span style="color:#79B8FF;">dict</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> json.loads(fn_call[</span><span style="color:#9ECBFF;">&quot;arguments&quot;</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">            fn_res: </span><span style="color:#79B8FF;">str</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> json.dumps(get_function_by_name(fn_name)(</span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">fn_args))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            messages.append({</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;role&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;tool&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;content&quot;</span><span style="color:#E1E4E8;">: fn_res,</span></span>
<span class="line"><span style="color:#9ECBFF;">                &quot;tool_call_id&quot;</span><span style="color:#E1E4E8;">: call_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">            })</span></span></code></pre></div><p>It should be noted that the OpenAI API uses <code>tool_call_id</code> to identify the relation between tool results and tool calls.</p><p>The messages are now like</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">[</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;system&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">Current Date: 2024-09-30&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;user&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;What&#39;s the temperature in San Francisco now? How about tomorrow?&quot;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;assistant&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function_call&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tool_calls&#39;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span><span style="color:#9ECBFF;">&#39;id&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;chatcmpl-tool-924d705adb044ff88e0ef3afdd155f15&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;location&quot;: &quot;San Francisco, CA, USA&quot;}&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_current_temperature&#39;</span><span style="color:#E1E4E8;">}, </span><span style="color:#9ECBFF;">&#39;type&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span><span style="color:#9ECBFF;">&#39;id&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;chatcmpl-tool-7e30313081944b11b6e5ebfd02e8e501&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">: {</span><span style="color:#9ECBFF;">&#39;arguments&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;}&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;get_temperature_date&#39;</span><span style="color:#E1E4E8;">}, </span><span style="color:#9ECBFF;">&#39;type&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    ]},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;tool&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;temperature&quot;: 26.1, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tool_call_id&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;chatcmpl-tool-924d705adb044ff88e0ef3afdd155f15&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;tool&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;content&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{&quot;temperature&quot;: 25.9, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;, &quot;unit&quot;: &quot;celsius&quot;}&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tool_call_id&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;chatcmpl-tool-7e30313081944b11b6e5ebfd02e8e501&#39;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><h4 id="final-response-3" tabindex="-1">Final Response <a class="header-anchor" href="#final-response-3" aria-label="Permalink to &quot;Final Response&quot;">​</a></h4><p>Let&#39;s call the endpoint again to seed the tool results and get response:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">response </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> client.chat.completions.create(</span></span>
<span class="line"><span style="color:#FFAB70;">    model</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">model_name,</span></span>
<span class="line"><span style="color:#FFAB70;">    messages</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">messages,</span></span>
<span class="line"><span style="color:#FFAB70;">    tools</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">tools,</span></span>
<span class="line"><span style="color:#FFAB70;">    temperature</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.7</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#FFAB70;">    top_p</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.8</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#FFAB70;">    max_tokens</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">512</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#FFAB70;">    extra_body</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#9ECBFF;">        &quot;repetition_penalty&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1.05</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">messages.append(response.choices[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].message.model_dump())</span></span></code></pre></div><p>The final response (<code>response.choices[0].message.content</code>) should be like</p><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>The current temperature in San Francisco is approximately 26.1°C. For tomorrow, the forecasted temperature is around 25.9°C.</span></span></code></pre></div><h3 id="discussions" tabindex="-1">Discussions <a class="header-anchor" href="#discussions" aria-label="Permalink to &quot;Discussions&quot;">​</a></h3><p>Now, we have introduced how to conduct inference with function calling using Qwen2 in three different frameworks! Let&#39;s make a brief comparison.</p><table tabindex="0"><thead><tr><th style="text-align:left;">Item</th><th style="text-align:center;">OpenAI API</th><th style="text-align:center;">Hugging Face transformers</th><th style="text-align:center;">Ollama</th><th style="text-align:center;">vLLM</th><th style="text-align:center;">Qwen-Agent</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:center;">HTTP API</td><td style="text-align:center;">Python Library</td><td style="text-align:center;">HTTP API</td><td style="text-align:center;">HTTP API</td><td style="text-align:center;">Python Library</td></tr><tr><td style="text-align:left;">Inference Backend</td><td style="text-align:center;">-</td><td style="text-align:center;">PyTorch</td><td style="text-align:center;">llama.cpp</td><td style="text-align:center;">PyTorch</td><td style="text-align:center;">HTTP API</td></tr><tr><td style="text-align:left;">Templating Backend</td><td style="text-align:center;">-</td><td style="text-align:center;">Jinja</td><td style="text-align:center;">Go <code>text/template</code></td><td style="text-align:center;">Jinja</td><td style="text-align:center;">Python</td></tr><tr><td style="text-align:left;">Tools/Functions</td><td style="text-align:center;">Tools</td><td style="text-align:center;">Tools</td><td style="text-align:center;">Tools</td><td style="text-align:center;">Tools</td><td style="text-align:center;">Functions</td></tr><tr><td style="text-align:left;">Parallel Calls</td><td style="text-align:center;">Default Yes (Configurable)</td><td style="text-align:center;">Yes</td><td style="text-align:center;">Yes</td><td style="text-align:center;">Yes</td><td style="text-align:center;">Default No (Configurable)</td></tr><tr><td style="text-align:left;">Call Format</td><td style="text-align:center;">Single assistant message with <code>tool_calls</code></td><td style="text-align:center;">Single assistant message with <code>tool_calls</code></td><td style="text-align:center;">Single assistant message with <code>tool_calls</code></td><td style="text-align:center;">Single assistant message with <code>tool_calls</code></td><td style="text-align:center;">Multiple assistant messages with <code>function_call</code></td></tr><tr><td style="text-align:left;">Call Argument Format</td><td style="text-align:center;">string</td><td style="text-align:center;">object</td><td style="text-align:center;">object</td><td style="text-align:center;">string</td><td style="text-align:center;">string</td></tr><tr><td style="text-align:left;">Call Result Format</td><td style="text-align:center;">Multiple tool messages with <code>content</code></td><td style="text-align:center;">Multiple tool messages with <code>content</code></td><td style="text-align:center;">Multiple tool messages with <code>content</code></td><td style="text-align:center;">Multiple tool messages with <code>content</code></td><td style="text-align:center;">Multiple function messages with <code>content</code></td></tr></tbody></table><p>There are some details not shown in the above table:</p><ul><li>OpenAI API comes with Python, Node.js, Go, and .NET SDKs. It also follows the OpenAPI standard.</li><li>Ollama comes with Python and Node.js SDKs. It has OpenAI-compatible API at a different base url that can be accessed using OpenAI API SDK.</li><li>Qwen-Agent as an application framework can call the tools automatically for you, which is introduced in <a href="./qwen_agent.html">the Qwen-Agent guide</a>.</li></ul><p>In addition, there are more on the model side of function calling, which means you may need to consider more things in production code:</p><ul><li><strong>Accuracy of function calling</strong>: When it comes to evaluate the accuracy of function calling, there are two aspects: (a) whether the correct functions (including no functions) are selected and (b) whether the correct function arguments are generated. It is not always the case that Qwen2.5 will be accurate. Function calling can involve knowledge that is deep and domain-specific. Sometimes, it doesn&#39;t fully understand the function and select the wrong one by mistake. Sometimes, it can fall into a loop and require calling the same function again and again. Sometimes, it will fabricate required function arguments instead of asking the user for input. To improve the function calling accuracy, it is advised to first try prompt engineering: does a more detailed function description help? can we provide instructions and examples to the model in the system message? If not, finetuning on your own data could also improve performance.</li><li><strong>Protocol consistency</strong>: Even with the proper function calling template, the protocol may break. The model may generate extra texts to tool calls, e.g., explanations. The generated tool call may be invalid JSON-formatted string but a representation of a Python dict The generated tool call may be valid JSON but not conforms to the provided JSON Schema. For those kinds of issues, while some of them could be addressed with prompt engineering, some are caused by the nature of LLMs and can be hard to resolve in a general manner by LLMs themselves. While we strive to improve Qwen2.5 in this regard, edge cases are unlikely to be eliminated completely.</li></ul><h2 id="function-calling-templates" tabindex="-1">Function Calling Templates <a class="header-anchor" href="#function-calling-templates" aria-label="Permalink to &quot;Function Calling Templates&quot;">​</a></h2><p>The template design for function calling often includes the following aspects:</p><ul><li>How to describe the functions to the model, so that the model understands what they are and how to use them.</li><li>How to prompt the model, so that it knows that functions can be used and in what format to generate the function calls.</li><li>How to tell a function call generation from others in generated text, so that we can extract the calls from the generated texts and actually make the calls.</li><li>How to incorporate the function results to the text, so that the model can tell them from its own generation and make connection among the calls and the results.</li></ul><p>For experienced prompt engineers, it should be possible to make any LLM support function calling, using in-context learning techniques and with representative examples, though with varied accuracy and stability depending on how &quot;zero-shot&quot; the task at hand is.</p><h3 id="starting-from-react-prompting" tabindex="-1">Starting from ReAct Prompting <a class="header-anchor" href="#starting-from-react-prompting" aria-label="Permalink to &quot;Starting from ReAct Prompting&quot;">​</a></h3><p>For example, ReAct Prompting can be used to implement function calling with an extra element of planning:</p><ul><li><strong>Thought</strong>: the overt reasoning path, analyzing the functions and the user query and saying it out &quot;loud&quot;</li><li><strong>Action</strong>: the function to use and the arguments with which the function should be called</li><li><strong>Observation</strong>: the results of the function</li></ul><p>In fact, Qwen2 is verse in the following variant of ReAct Prompting (similar to LangChain ReAct) to make the intermediate texts more structured:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>Answer the following questions as best you can. You have access to the following tools:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>{function_name}: Call this tool to interact with the {function_name_human_readable} API. What is the {function_name_human_readable} API useful for? {function_desciption} Parameters: {function_parameter_descriptions} {argument_formatting_instructions}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>{function_name}: Call this tool to interact with the {function_name_human_readable} API. What is the {function_name_human_readable} API useful for? {function_desciption} Parameters: {function_parameter_descriptions} {argument_formatting_instructions}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Use the following format:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Question: the input question you must answer</span></span>
<span class="line"><span>Thought: you should always think about what to do</span></span>
<span class="line"><span>Action: the action to take, should be one of [{function_name},{function_name}]</span></span>
<span class="line"><span>Action Input: the input to the action</span></span>
<span class="line"><span>Observation: the result of the action</span></span>
<span class="line"><span>... (this Thought/Action/Action Input/Observation can be repeated zero or more times)</span></span>
<span class="line"><span>Thought: I now know the final answer</span></span>
<span class="line"><span>Final Answer: the final answer to the original input question</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Begin!</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Question: {query}</span></span>
<span class="line"><span>Thought: {some_text}</span></span>
<span class="line"><span>Action: {function_name}</span></span>
<span class="line"><span>Action Input: {function_arguments}</span></span>
<span class="line"><span>Observation: {function_results}</span></span>
<span class="line"><span>Final Answer: {response}</span></span></code></pre></div><p>As you can see, there is no apparent user/assistant conversation structure in the template. The model will simply continue the texts. One should write the code to actively detect which step the model is at and in particular to add the observations in the process, until the Final Answer is generated.</p><p>However, as most programming interfaces accept the message structure, there should be some kind of adapter between the two. <a href="https://github.com/QwenLM/Qwen-Agent/blob/v0.0.10/qwen_agent/agents/react_chat.py" target="_blank" rel="noreferrer">The ReAct Chat Agent</a> in Qwen-Agent facilitates this kind of conversion.</p><h3 id="qwen2-function-calling-template" tabindex="-1">Qwen2 Function Calling Template <a class="header-anchor" href="#qwen2-function-calling-template" aria-label="Permalink to &quot;Qwen2 Function Calling Template&quot;">​</a></h3><p>As a step forward, the official Qwen2 function calling template is in the vein of the ReAct Prompting format but focuses more on</p><ul><li>differentiating the keywords like <code>Question</code>, <code>Thought</code>, <code>Action</code>, etc., from generation,</li><li>simplifying the process,</li><li>supporting better multi-turn conversation, and</li><li>adding controls for specialized usage.</li></ul><p>An equivalent example would be</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;|im_start|&gt;system</span></span>
<span class="line"><span>{system message}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>## Tools</span></span>
<span class="line"><span></span></span>
<span class="line"><span>You have access to the following tools:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>### {function_name_human_readable}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>{function_name}: {function_description} Parameters: {function_parameter_descriptions} {argument_formatting_instructions}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>### {function_name_human_readable}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>{function_name}: {function_description} Parameters: {function_parameter_descriptions} {argument_formatting_instructions}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>## When you need to call a tool, please insert the following command in your reply, which can be called zero or multiple times according to your needs:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>✿FUNCTION✿: The tool to use, should be one of [{function_name},{function_name}]</span></span>
<span class="line"><span>✿ARGS✿: The input of the tool</span></span>
<span class="line"><span>✿RESULT✿: Tool results</span></span>
<span class="line"><span>✿RETURN✿: Reply based on tool results. Images need to be rendered as ![](url)&lt;|im_end|&gt;</span></span>
<span class="line"><span>&lt;|im_start|&gt;user</span></span>
<span class="line"><span>{query}&lt;|im_end|&gt;</span></span>
<span class="line"><span>&lt;|im_start|&gt;assistant</span></span>
<span class="line"><span>✿FUNCTION✿: {function_name}</span></span>
<span class="line"><span>✿ARGS✿: {function_arguments}</span></span>
<span class="line"><span>✿RESULT✿: {function_result}</span></span>
<span class="line"><span>✿RETURN✿:{response}&lt;|im_end|&gt;</span></span></code></pre></div><p>Let&#39;s first list the obvious differences:</p><ul><li>Keywords (<code>✿FUNCTION✿</code>, <code>✿ARGS✿</code>, etc.) seem rare in ordinary text and more semantically related to function calling, but not special tokens yet.</li><li>Thought is omitted. This could affect accuracy for some use cases.</li><li>Use the system-user-assistant format for multi-turn conversations. Function calling prompting is moved to the system message.</li></ul><p>How about adding controls for specialized usage? The template actually has the following variants:</p><ul><li>Language: the above is for non-Chinese language; there is another template in Chinese.</li><li>Parallel Calls: the above is for non-parallel calls; there is another template for parallel calls.</li></ul><p>In the canonical implementation in Qwen-Agent, those switches are implemented in Python, according to the configuration and current input.</p><p>The actual text with <em>parallel calls</em> should be like the following:</p><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;|im_start|&gt;system</span></span>
<span class="line"><span>You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Current Date: 2024-09-30</span></span>
<span class="line"><span></span></span>
<span class="line"><span>## Tools</span></span>
<span class="line"><span></span></span>
<span class="line"><span>You have access to the following tools:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>### get_current_temperature</span></span>
<span class="line"><span></span></span>
<span class="line"><span>get_current_temperature: Get current temperature at a location. Parameters: {&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;location&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;The location to get the temperature for, in the format \\&quot;City, State, Country\\&quot;.&quot;}, &quot;unit&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;enum&quot;: [&quot;celsius&quot;, &quot;fahrenheit&quot;], &quot;description&quot;: &quot;The unit to return the temperature in. Defaults to \\&quot;celsius\\&quot;.&quot;}}, &quot;required&quot;: [&quot;location&quot;]} Format the arguments as a JSON object.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>### get_temperature_date</span></span>
<span class="line"><span></span></span>
<span class="line"><span>get_temperature_date: Get temperature at a location and date. Parameters: {&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;location&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;The location to get the temperature for, in the format \\&quot;City, State, Country\\&quot;.&quot;}, &quot;date&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;The date to get the temperature for, in the format \\&quot;Year-Month-Day\\&quot;.&quot;}, &quot;unit&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;enum&quot;: [&quot;celsius&quot;, &quot;fahrenheit&quot;], &quot;description&quot;: &quot;The unit to return the temperature in. Defaults to \\&quot;celsius\\&quot;.&quot;}}, &quot;required&quot;: [&quot;location&quot;, &quot;date&quot;]} Format the arguments as a JSON object.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>## Insert the following command in your reply when you need to call N tools in parallel:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>✿FUNCTION✿: The name of tool 1, should be one of [get_current_temperature,get_temperature_date]</span></span>
<span class="line"><span>✿ARGS✿: The input of tool 1</span></span>
<span class="line"><span>✿FUNCTION✿: The name of tool 2</span></span>
<span class="line"><span>✿ARGS✿: The input of tool 2</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>✿FUNCTION✿: The name of tool N</span></span>
<span class="line"><span>✿ARGS✿: The input of tool N</span></span>
<span class="line"><span>✿RESULT✿: The result of tool 1</span></span>
<span class="line"><span>✿RESULT✿: The result of tool 2</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>✿RESULT✿: The result of tool N</span></span>
<span class="line"><span>✿RETURN✿: Reply based on tool results. Images need to be rendered as ![](url)&lt;|im_end|&gt;</span></span>
<span class="line"><span>&lt;|im_start|&gt;user</span></span>
<span class="line"><span>What&#39;s the temperature in San Francisco now? How about tomorrow?&lt;|im_end|&gt;</span></span>
<span class="line"><span>&lt;|im_start|&gt;assistant</span></span>
<span class="line"><span>✿FUNCTION✿: get_current_temperature</span></span>
<span class="line"><span>✿ARGS✿: {&quot;location&quot;: &quot;San Francisco, CA, USA&quot;}</span></span>
<span class="line"><span>✿FUNCTION✿: get_temperature_date</span></span>
<span class="line"><span>✿ARGS✿: {&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;}</span></span>
<span class="line"><span>✿RESULT✿: {&quot;temperature&quot;: 26.1, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;unit&quot;: &quot;celsius&quot;}</span></span>
<span class="line"><span>✿RESULT✿: {&quot;temperature&quot;: 25.9, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;, &quot;unit&quot;: &quot;celsius&quot;}</span></span>
<span class="line"><span>✿RETURN✿: The current temperature in San Francisco is approximately 26.1°C. For tomorrow, October 1st, 2024, the forecasted temperature will be around 25.9°C.&lt;|im_end|&gt;</span></span></code></pre></div><p>This template is hard to adapt it for other frameworks that use less capable templating engines. But it is doable at least partially for Jinja, which is Python-oriented after all. We didn&#39;t use it because using the template in <code>transformers</code> leads to more changes to the inference usage, which are not very common for beginners.</p><p>For the interested, you can find the Jinja template and key points on usage below:</p><p>:::{dropdown} Qwen2 Function Calling Jinja Template</p><div class="language-jinja"><button title="Copy Code" class="copy"></button><span class="lang">jinja</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> messages[0][</span><span style="color:#9ECBFF;">&quot;role&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;system&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> set</span><span style="color:#E1E4E8;"> system_message </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> messages[0][</span><span style="color:#9ECBFF;">&quot;content&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> set</span><span style="color:#E1E4E8;"> loop_messages </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> messages[1:] </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> else</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> set</span><span style="color:#E1E4E8;"> system_message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;You are a helpful assistant.&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> set</span><span style="color:#E1E4E8;"> loop_messages </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> messages </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> parallel_tool_calls </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> undefined </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> set</span><span style="color:#E1E4E8;"> parallel_tool_calls </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> false</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> language </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> undefined </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> language </span><span style="color:#F97583;">!=</span><span style="color:#9ECBFF;"> &quot;zh&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> set</span><span style="color:#E1E4E8;"> language </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;en&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFAB70;">{{- </span><span style="color:#9ECBFF;">&quot;&lt;|im_start|&gt;system</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> system_message</span><span style="color:#FFAB70;">|</span><span style="color:#E1E4E8;">trim</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> tools </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> defined </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#FFAB70;">    {{- </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;"># 工具</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">## 你拥有如下工具：</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> language</span><span style="color:#F97583;"> ==</span><span style="color:#9ECBFF;"> &quot;zh&quot;</span><span style="color:#F97583;"> else</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">## Tools</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">You have access to the following tools:</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> set</span><span style="color:#E1E4E8;"> functions </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tools|map(attribute</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">)|list </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> set</span><span style="color:#E1E4E8;"> function_names </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> functions|map(attribute</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;name&quot;</span><span style="color:#E1E4E8;">)|join(</span><span style="color:#9ECBFF;">&quot;,&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> for</span><span style="color:#E1E4E8;"> function </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> functions </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#9ECBFF;">&quot;### &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">description</span><span style="color:#F97583;"> +</span><span style="color:#FFAB70;"> (</span><span style="color:#9ECBFF;">&quot; 输入参数：&quot;</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> language</span><span style="color:#F97583;"> ==</span><span style="color:#9ECBFF;"> &quot;zh&quot;</span><span style="color:#F97583;"> else</span><span style="color:#9ECBFF;"> &quot; Parameters: &quot;</span><span style="color:#FFAB70;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> function</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">parameters</span><span style="color:#FFAB70;">|</span><span style="color:#E1E4E8;">tojson</span><span style="color:#F97583;"> +</span><span style="color:#FFAB70;"> (</span><span style="color:#9ECBFF;">&quot; 此工具的输入应为JSON对象。</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> language</span><span style="color:#F97583;"> ==</span><span style="color:#9ECBFF;"> &quot;zh&quot;</span><span style="color:#F97583;"> else</span><span style="color:#9ECBFF;"> &quot; Format the arguments as a JSON object.</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#FFAB70;">) }}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> endfor</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> parallel_tool_calls </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> language </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;zh&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#9ECBFF;">&quot;## 你可以在回复中插入以下命令以并行调用N个工具：</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">✿FUNCTION✿: 工具1的名称，必须是[&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function_names</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;]之一</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: 工具1的输入</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿FUNCTION✿: 工具2的名称</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: 工具2的输入</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">...</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿FUNCTION✿: 工具N的名称</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: 工具N的输入</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RESULT✿: 工具1的结果</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RESULT✿: 工具2的结果</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">...</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RESULT✿: 工具N的结果</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RETURN✿: 根据工具结 果进行回复，需将图片用![](url)渲染出来&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> elif</span><span style="color:#E1E4E8;"> parallel_tool_calls </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#9ECBFF;">&quot;## Insert the following command in your reply when you need to call N tools in parallel:</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">✿FUNCTION✿: The name of tool 1, should be one of [&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function_names</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;]</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: The input of tool 1</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿FUNCTION✿: The name of tool 2</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: The input of tool 2</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">...</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿FUNCTION✿: The name of tool N</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: The input of tool N</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RESULT✿: The result of tool 1</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RESULT✿: The result of tool 2</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">...</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RESULT✿: The result of tool N</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RETURN✿: Reply based on tool results. Images need to be rendered as ![](url)&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> elif</span><span style="color:#E1E4E8;"> language </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;zh&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#9ECBFF;">&quot;## 你可以在回复中插入零次、一次或多次以下命令以调用工具：</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">✿FUNCTION✿: 工具名称，必须是[&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function_names</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;]之一。</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: 工具输入</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RESULT✿: 工具结果</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RETURN✿: 根据工具结果进行回复，需将图片用![](url)渲染出来&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> else</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#9ECBFF;">&quot;## When you need to call a tool, please insert the following command in your reply, which can be called zero or multiple times according to your needs:</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">✿FUNCTION✿: The tool to use, should be one of [&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function_names</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;]</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: The input of the tool</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RESULT✿: Tool results</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿RETURN✿: Reply based on tool results. Images need to be rendered as ![](url)&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">{{- </span><span style="color:#9ECBFF;">&quot;&lt;|im_end|&gt;&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> for</span><span style="color:#E1E4E8;"> message </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> loop_messages </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> message.role </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;user&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&lt;|im_start|&gt;&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> message</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">role</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> message</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">content</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;&lt;|im_end|&gt;&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> if</span><span style="color:#79B8FF;"> loop</span><span style="color:#E1E4E8;">.last </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> add_generation_prompt </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#FFAB70;">            {{- </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&lt;|im_start|&gt;assistant</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> elif</span><span style="color:#E1E4E8;"> message.role </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;tool&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#9ECBFF;">&quot;✿RESULT✿: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> message</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">content</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> if</span><span style="color:#79B8FF;"> loop</span><span style="color:#E1E4E8;">.last </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> add_generation_prompt </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#FFAB70;">            {{- </span><span style="color:#9ECBFF;">&quot;✿RETURN✿:&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> elif</span><span style="color:#E1E4E8;"> message.role </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;assistant&quot;</span><span style="color:#F97583;"> and</span><span style="color:#E1E4E8;"> message.tool_calls </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> defined </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> if</span><span style="color:#79B8FF;"> loop</span><span style="color:#E1E4E8;">.previtem.role </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;user&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">            {{- </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&lt;|im_start|&gt;assistant</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> for</span><span style="color:#E1E4E8;"> function </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> message.tool_calls|map(attribute</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">%}</span></span>
<span class="line"><span style="color:#FFAB70;">            {{- </span><span style="color:#9ECBFF;">&quot;✿FUNCTION✿: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">✿ARGS✿: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> function</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">arguments</span><span style="color:#FFAB70;">|</span><span style="color:#E1E4E8;">tojson</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> endfor</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> elif</span><span style="color:#E1E4E8;"> message.role </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;assistant&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> if</span><span style="color:#79B8FF;"> loop</span><span style="color:#E1E4E8;">.previtem.role </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;user&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">            {{- </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&lt;|im_start|&gt;assistant</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> elif</span><span style="color:#79B8FF;"> loop</span><span style="color:#E1E4E8;">.previtem.role </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;tool&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">            {{- </span><span style="color:#9ECBFF;">&quot;✿RETURN✿:&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#E1E4E8;">message</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">content</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> if</span><span style="color:#79B8FF;"> loop</span><span style="color:#E1E4E8;">.nextitem </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> undefined </span><span style="color:#F97583;">or</span><span style="color:#79B8FF;"> loop</span><span style="color:#E1E4E8;">.nextitem.role </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &quot;user&quot;</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">            {{- </span><span style="color:#9ECBFF;">&quot;&lt;|im_end|&gt;&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">        {%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> else</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#FFAB70;">        {{- </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&lt;|im_start|&gt;&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> message</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">role</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> message</span><span style="color:#FFAB70;">.</span><span style="color:#E1E4E8;">content</span><span style="color:#F97583;"> +</span><span style="color:#9ECBFF;"> &quot;&lt;|im_end|&gt;&quot;</span><span style="color:#FFAB70;"> }}</span></span>
<span class="line"><span style="color:#B392F0;">    {%-</span><span style="color:#F97583;"> endif</span><span style="color:#B392F0;"> %}</span></span>
<span class="line"><span style="color:#B392F0;">{%-</span><span style="color:#F97583;"> endfor</span><span style="color:#B392F0;"> %}</span></span></code></pre></div><p>To use this template in <code>transformers</code>:</p><ul><li><p>Switches can be enabled by passing them to the <code>apply_chat_template</code> method, e.g., <code>tokenizer.apply_chat_template(messages, tools=tools, add_generation_prompt=True, parallel_tool_call=True, language=&quot;zh&quot;, tokenize=False)</code>. By default, it is for English non-parallel function calling.</p></li><li><p>The tool arguments should be a Python <code>dict</code> instead of a JSON-formatted object <code>str</code>.</p></li><li><p>Since the generation needs to be stopped at <code>✿RESULT✿</code> or else the model will generate fabricated tool results, we should add it to <code>stop_strings</code> in <code>generation_config</code>:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">model.generation_config.stop_strings </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;✿RESULT✿:&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;✿RETURN✿:&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre></div></li><li><p>As a result of using <code>stop_strings</code>, you need to pass the tokenizer to <code>model.generate</code> as <code>model.generate(**inputs, tokenizer=tokenizer, max_new_tokens=512)</code>.</p></li><li><p><code>response</code>, i.e., the model generation based on the tool calls and tool results, may contain a leading space. You should not strip it for the model. It is resulted from the tokenization and the template design.</p></li><li><p>The <code>try_parse_tool_calls</code> function should also be modified accordingly. :::</p></li></ul><h3 id="qwen2-5-function-calling-templates" tabindex="-1">Qwen2.5 Function Calling Templates <a class="header-anchor" href="#qwen2-5-function-calling-templates" aria-label="Permalink to &quot;Qwen2.5 Function Calling Templates&quot;">​</a></h3><p>For <code>transformers</code> and Ollama, we have also used templates that are easier to implement with Jinja or Go. They are variants of <a href="https://github.com/NousResearch/Hermes-Function-Calling#prompt-format-for-function-calling" target="_blank" rel="noreferrer">the Nous Research&#39;s Hermes function calling template</a>. The Jinja template and the Go template should produce basically the same results. They final text should look like the following:</p><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;|im_start|&gt;system</span></span>
<span class="line"><span>You are Qwen, created by Alibaba Cloud. You are a helpful assistant.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Current Date: 2024-09-30</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Tools</span></span>
<span class="line"><span></span></span>
<span class="line"><span>You may call one or more functions to assist with the user query.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>You are provided with function signatures within &lt;tools&gt;&lt;/tools&gt; XML tags:</span></span>
<span class="line"><span>&lt;tools&gt;</span></span>
<span class="line"><span>{&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: {&quot;name&quot;: &quot;get_current_temperature&quot;, &quot;description&quot;: &quot;Get current temperature at a location.&quot;, &quot;parameters&quot;: {&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;location&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;The location to get the temperature for, in the format \\&quot;City, State, Country\\&quot;.&quot;}, &quot;unit&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;enum&quot;: [&quot;celsius&quot;, &quot;fahrenheit&quot;], &quot;description&quot;: &quot;The unit to return the temperature in. Defaults to \\&quot;celsius\\&quot;.&quot;}}, &quot;required&quot;: [&quot;location&quot;]}}}</span></span>
<span class="line"><span>{&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: {&quot;name&quot;: &quot;get_temperature_date&quot;, &quot;description&quot;: &quot;Get temperature at a location and date.&quot;, &quot;parameters&quot;: {&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;location&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;The location to get the temperature for, in the format \\&quot;City, State, Country\\&quot;.&quot;}, &quot;date&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;The date to get the temperature for, in the format \\&quot;Year-Month-Day\\&quot;.&quot;}, &quot;unit&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;enum&quot;: [&quot;celsius&quot;, &quot;fahrenheit&quot;], &quot;description&quot;: &quot;The unit to return the temperature in. Defaults to \\&quot;celsius\\&quot;.&quot;}}, &quot;required&quot;: [&quot;location&quot;, &quot;date&quot;]}}}</span></span>
<span class="line"><span>&lt;/tools&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>For each function call, return a json object with function name and arguments within &lt;tool_call&gt;&lt;/tool_call&gt; XML tags:</span></span>
<span class="line"><span>&lt;tool_call&gt;</span></span>
<span class="line"><span>{&quot;name&quot;: &lt;function-name&gt;, &quot;arguments&quot;: &lt;args-json-object&gt;}</span></span>
<span class="line"><span>&lt;/tool_call&gt;&lt;|im_end|&gt;</span></span>
<span class="line"><span>&lt;|im_start|&gt;user</span></span>
<span class="line"><span>What&#39;s the temperature in San Francisco now? How about tomorrow?&lt;|im_end|&gt;</span></span>
<span class="line"><span>&lt;|im_start|&gt;assistant</span></span>
<span class="line"><span>&lt;tool_call&gt;</span></span>
<span class="line"><span>{&quot;name&quot;: &quot;get_current_temperature&quot;, &quot;arguments&quot;: {&quot;location&quot;: &quot;San Francisco, CA, USA&quot;}}</span></span>
<span class="line"><span>&lt;/tool_call&gt;</span></span>
<span class="line"><span>&lt;tool_call&gt;</span></span>
<span class="line"><span>{&quot;name&quot;: &quot;get_temperature_date&quot;, &quot;arguments&quot;: {&quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;}}</span></span>
<span class="line"><span>&lt;/tool_call&gt;&lt;|im_end|&gt;</span></span>
<span class="line"><span>&lt;|im_start|&gt;user</span></span>
<span class="line"><span>&lt;tool_response&gt;</span></span>
<span class="line"><span>{&quot;temperature&quot;: 26.1, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;unit&quot;: &quot;celsius&quot;}</span></span>
<span class="line"><span>&lt;/tool_response&gt;</span></span>
<span class="line"><span>&lt;tool_response&gt;</span></span>
<span class="line"><span>{&quot;temperature&quot;: 25.9, &quot;location&quot;: &quot;San Francisco, CA, USA&quot;, &quot;date&quot;: &quot;2024-10-01&quot;, &quot;unit&quot;: &quot;celsius&quot;}</span></span>
<span class="line"><span>&lt;/tool_response&gt;&lt;|im_end|&gt;</span></span>
<span class="line"><span>&lt;|im_start|&gt;assistant</span></span>
<span class="line"><span>The current temperature in San Francisco is approximately 26.1°C. Tomorrow, on October 1, 2024, the temperature is expected to be around 25.9°C.&lt;|im_end|&gt;</span></span></code></pre></div><p>While the text may seem different from the previous one, the basic prompting structure is still the same. There are just more structural tags and more JSON-formatted strings.</p><hr><p>There is one thing we haven&#39;t talked about: how should functions be described to the LLMs. In short, you could describe them as you would normally describe them in an API documentation, as long as you can effectively parse, validate, and execute the tool calls generated by the models. The format with JSON Schema appears a valid and common choice.</p><h2 id="finally" tabindex="-1">Finally <a class="header-anchor" href="#finally" aria-label="Permalink to &quot;Finally&quot;">​</a></h2><p>In whichever way you choose to use function calling with Qwen2.5, keep in mind that the limitation and the perks of prompt engineering applies:</p><ul><li>It is not guaranteed that the model generation will always follow the protocol even with proper prompting or templates. Especially, for the templates that are more complex and relies more on the model itself to think and stay on track than the ones that are simpler and relies on the template and the use of control or special tokens. The latter one, of course, requires some kind of training. In production code, be prepared that if it breaks, countermeasures or rectifications are in place.</li><li>If in certain scenarios, the generation is not up to expectation, you can refine the template to add more instructions or constraints. While the templates mentioned here are general enough, they may not be the best or the most specific or the most concise for your use cases. The ultimate solution is fine-tuning using your own data.</li></ul><p>Have fun prompting!</p>`,225)]))}const F=n(t,[["render",l]]);export{y as __pageData,F as default};
